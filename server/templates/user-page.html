<html>
  <head>
    <title>{{ version.content.heading }} - Thread</title>
    {% include 'scripts.html' %}
    {% include 'diffstyles.html' %}
  </head>

  <script>
    window.num = {{ version.num }};

    function editelem(buttonid, plainid, diffid, url) {
      let button = document.getElementById(buttonid);
      if (button.innerText == 'Edit') {
        button.innerText = 'Done';
        document.getElementById(plainid).removeAttribute('hidden');
        document.getElementById(diffid).setAttribute('hidden', true);
      } else {
        signal(url, {
          body: document.getElementById(plainid).innerHTML,
          num: window.num,
        }).then((response) => {
          if (response.increment) {
            window.num += 1;
          }
          if (response.done) {
            button.innerText = 'Edit';
            document.getElementById(plainid).setAttribute('hidden', true);
            document.getElementById(diffid).removeAttribute('hidden');
          }
        });
      }
    }

    function editsection(idx, url) {
      editelem("edit-section-" + idx, 'section-body-' + idx, 'section-diff-' + idx, url);
    }

    function editsummary(url) {
      editelem('edit-summary', 'summary-body', 'summary-diff', url);
    }
  </script>

  <body>
    {% include 'modules/login.html' %}

    <a href="{{ url_for('index') }}">Home</a>

    {% from 'page-utils.html' import showheadingdiff %}
    {{ showheadingdiff(version) }}
    <a href="{{ url_for('edit', title=title) }}">Edit page</a>
    <a href="{{ url_for('history', title=title) }}">History</a>

    <div id="summary-diff">{{ version.primarydiff.summary|safe }}</div>
    <div id="summary-body" contenteditable="true" hidden="true">{{ version.content.summary|safe }}</div>
    {% if g.user %}
      <button type="button" id="edit-summary" onclick="editsummary('{{ url_for('summaryedit', title=title) }}')">Edit</button>
    {% endif %}

    {% from 'page-utils.html' import header_at_level %}
    {% for section in version.primarydiff.sections %}
      {% if section.deleted %}
        <div><del>[]</del></div>
      {% else %}
        {% set header %}
          {% if section.inserted %}
            <ins>[{{ section.header }}]</ins>
          {% else %}
            {{ section.header }}
          {% endif %}
          {% if g.user %}
            <button type="button" id="edit-section-{{ section.idx }}" onclick="editsection({{ section.idx }}, '{{ url_for('sectionedit', title=title, idx=section.idx) }}')">Edit</button>
          {% endif %}
        {% endset %}

        {{ header_at_level(header, section.level) }}
        <div id="editerror-section-{{ section.idx }}"></div>
        <div id="section-diff-{{ section.idx }}">{{ section.diff|safe }}</div>
        <div id="section-body-{{ section.idx }}" contenteditable="true" hidden="true">{{ section.body|safe }}</div>
      {% endif %}
    {% endfor %}

  </body>
</html>
